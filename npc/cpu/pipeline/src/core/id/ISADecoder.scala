package treecorel2

import chisel3._
import chisel3.util._

object ISADecoder {
  // according to the The RISC-V Instruction Set Manual Volume I: Unprivileged ISA
  // Document Version: 20191213
  // DESC page [15-25] ABI page[130-131]

  /* Integer Register-Immediate Instructions */
  // I type inst
  def ADDI  = BitPat("b?????????????????000?????0010011")
  def ADDIW = BitPat("b?????????????????000?????0011011")
  def SLTI  = BitPat("b?????????????????010?????0010011")
  def SLTIU = BitPat("b?????????????????011?????0010011")

  def ANDI = BitPat("b?????????????????111?????0010011")
  def ORI  = BitPat("b?????????????????110?????0010011")
  def XORI = BitPat("b?????????????????100?????0010011")

  // special I type inst
  def SLLI  = BitPat("b000000???????????001?????0010011")
  def SLLIW = BitPat("b0000000??????????001?????0011011")
  def SRLI  = BitPat("b000000???????????101?????0010011")
  def SRLIW = BitPat("b0000000??????????101?????0011011")
  def SRAI  = BitPat("b010000???????????101?????0010011")
  def SRAIW = BitPat("b0100000??????????101?????0011011")
  // U type inst
  // LUI - rd = {imm, 12b'0}
  def LUI = BitPat("b?????????????????????????0110111")
  // AUIPC - rd = PC + {imm, 12b'0}
  def AUIPC = BitPat("b?????????????????????????0010111")

  /* Integer Register-Register Operations */
  // R type inst
  def ADD  = BitPat("b0000000??????????000?????0110011")
  def ADDW = BitPat("b0000000??????????000?????0111011")
  def SLT  = BitPat("b0000000??????????010?????0110011")
  def SLTU = BitPat("b0000000??????????011?????0110011")

  def AND = BitPat("b0000000??????????111?????0110011")
  def OR  = BitPat("b0000000??????????110?????0110011")
  def XOR = BitPat("b0000000??????????100?????0110011")

  def SLL  = BitPat("b0000000??????????001?????0110011")
  def SLLW = BitPat("b0000000??????????001?????0111011")
  def SRL  = BitPat("b0000000??????????101?????0110011")
  def SRLW = BitPat("b0000000??????????101?????0111011")

  def SUB  = BitPat("b0100000??????????000?????0110011")
  def SUBW = BitPat("b0100000??????????000?????0111011")
  def SRA  = BitPat("b0100000??????????101?????0110011")
  def SRAW = BitPat("b0100000??????????101?????0111011")

  // NOP - ADDI x0, 0x00(x0)
  def NOP = BitPat("b00000000000000000000000000010011")

  /* Control Transfer Instructions */
  // J type inst
  def JAL = BitPat("b?????????????????????????1101111")
  // I type inst
  def JALR = BitPat("b?????????????????000?????1100111")
  // B type inst
  def BEQ  = BitPat("b?????????????????000?????1100011")
  def BNE  = BitPat("b?????????????????001?????1100011")
  def BLT  = BitPat("b?????????????????100?????1100011")
  def BLTU = BitPat("b?????????????????110?????1100011")
  def BGE  = BitPat("b?????????????????101?????1100011")
  def BGEU = BitPat("b?????????????????111?????1100011")

  /* Load and Store Instructions */
  // I type inst
  def LB  = BitPat("b?????????????????000?????0000011")
  def LBU = BitPat("b?????????????????100?????0000011")
  def LH  = BitPat("b?????????????????001?????0000011")
  def LHU = BitPat("b?????????????????101?????0000011")
  def LW  = BitPat("b?????????????????010?????0000011")
  def LWU = BitPat("b?????????????????110?????0000011")
  def LD  = BitPat("b?????????????????011?????0000011")

  // S type inst
  def SB = BitPat("b?????????????????000?????0100011")
  def SH = BitPat("b?????????????????001?????0100011")
  def SW = BitPat("b?????????????????010?????0100011")
  def SD = BitPat("b?????????????????011?????0100011")

  // CSR inst
  def CSRRW  = BitPat("b?????????????????001?????1110011")
  def CSRRS  = BitPat("b?????????????????010?????1110011")
  def CSRRC  = BitPat("b?????????????????011?????1110011")
  def CSRRWI = BitPat("b?????????????????101?????1110011")
  def CSRRSI = BitPat("b?????????????????110?????1110011")
  def CSRRCI = BitPat("b?????????????????111?????1110011")

  // system inst
  def ECALL      = BitPat("b00000000000000000000000001110011")
  def EBREAK     = BitPat("b00000000000100000000000001110011")
  def URET       = BitPat("b00000000001000000000000001110011")
  def SRET       = BitPat("b00010000001000000000000001110011")
  def MRET       = BitPat("b00110000001000000000000001110011")
  def WFI        = BitPat("b00010000010100000000000001110011")
  def SFENCE_VMA = BitPat("b0001001??????????000000001110011")
  def FENCE      = BitPat("b0000????????00000000000000001111")
  def FENCE_I    = BitPat("b00000000000000000001000000001111")
  // custom inst such as 0x7B
  def CUST = BitPat("b0000000??????????000?????1111011")
}

class ISADecoder extends Module with InstConfig {
  val io = IO(new Bundle {
    val inst = Input(UInt(InstLen.W))
    val isa  = Output(UInt(InstValLen.W))
    val imm  = Output(UInt(XLen.W))
    val csr  = Output(new Bool())
    val wen  = Output(new Bool())
  })

  protected val csr = (io.isa === instCSRRW) || (io.isa === instCSRRS) || (io.isa === instCSRRC) || (io.isa === instCSRRWI) || (io.isa === instCSRRSI) || (io.isa === instCSRRCI)
  protected val decodeTable = Array(
    // i type inst
    ISADecoder.ADDI  -> List(iInstType, wtRegTrue, instADDI),
    ISADecoder.ADDIW -> List(iInstType, wtRegTrue, instADDIW),
    ISADecoder.SLTI  -> List(iInstType, wtRegTrue, instSLTI),
    ISADecoder.SLTIU -> List(iInstType, wtRegTrue, instSLTIU),
    ISADecoder.ANDI  -> List(iInstType, wtRegTrue, instANDI),
    ISADecoder.ORI   -> List(iInstType, wtRegTrue, instORI),
    ISADecoder.XORI  -> List(iInstType, wtRegTrue, instXORI),
    ISADecoder.SLLI  -> List(iInstType, wtRegTrue, instSLLI),
    ISADecoder.SLLIW -> List(iInstType, wtRegTrue, instSLLIW),
    ISADecoder.SRLI  -> List(iInstType, wtRegTrue, instSRLI),
    ISADecoder.SRLIW -> List(iInstType, wtRegTrue, instSRLIW),
    ISADecoder.SRAI  -> List(iInstType, wtRegTrue, instSRAI),
    ISADecoder.SRAIW -> List(iInstType, wtRegTrue, instSRAIW),
    // u type inst
    ISADecoder.LUI   -> List(uInstType, wtRegTrue, instLUI),
    ISADecoder.AUIPC -> List(uInstType, wtRegTrue, instAUIPC),
    // r type inst
    ISADecoder.ADD  -> List(rInstType, wtRegTrue, instADD),
    ISADecoder.ADDW -> List(rInstType, wtRegTrue, instADDW),
    ISADecoder.SLT  -> List(rInstType, wtRegTrue, instSLT),
    ISADecoder.SLTU -> List(rInstType, wtRegTrue, instSLTU),
    ISADecoder.AND  -> List(rInstType, wtRegTrue, instAND),
    ISADecoder.OR   -> List(rInstType, wtRegTrue, instOR),
    ISADecoder.XOR  -> List(rInstType, wtRegTrue, instXOR),
    ISADecoder.SLL  -> List(rInstType, wtRegTrue, instSLL),
    ISADecoder.SLLW -> List(rInstType, wtRegTrue, instSLLW),
    ISADecoder.SRL  -> List(rInstType, wtRegTrue, instSRL),
    ISADecoder.SRLW -> List(rInstType, wtRegTrue, instSRLW),
    ISADecoder.SUB  -> List(rInstType, wtRegTrue, instSUB),
    ISADecoder.SUBW -> List(rInstType, wtRegTrue, instSUBW),
    ISADecoder.SRA  -> List(rInstType, wtRegTrue, instSRA),
    ISADecoder.SRAW -> List(rInstType, wtRegTrue, instSRAW),
    // nop inst
    ISADecoder.NOP -> List(nopInstType, wtRegFalse, instNOP),
    // j type inst
    ISADecoder.JAL  -> List(jInstType, wtRegTrue, instJAL),
    ISADecoder.JALR -> List(iInstType, wtRegTrue, instJALR),
    // b type inst
    ISADecoder.BEQ  -> List(bInstType, wtRegFalse, instBEQ),
    ISADecoder.BNE  -> List(bInstType, wtRegFalse, instBNE),
    ISADecoder.BLT  -> List(bInstType, wtRegFalse, instBLT),
    ISADecoder.BLTU -> List(bInstType, wtRegFalse, instBLTU),
    ISADecoder.BGE  -> List(bInstType, wtRegFalse, instBGE),
    ISADecoder.BGEU -> List(bInstType, wtRegFalse, instBGEU),
    // special i type inst
    ISADecoder.LB  -> List(iInstType, wtRegTrue, instLB),
    ISADecoder.LBU -> List(iInstType, wtRegTrue, instLBU),
    ISADecoder.LH  -> List(iInstType, wtRegTrue, instLH),
    ISADecoder.LHU -> List(iInstType, wtRegTrue, instLHU),
    ISADecoder.LW  -> List(iInstType, wtRegTrue, instLW),
    ISADecoder.LWU -> List(iInstType, wtRegTrue, instLWU),
    ISADecoder.LD  -> List(iInstType, wtRegTrue, instLD),
    // s type inst
    ISADecoder.SB -> List(sInstType, wtRegFalse, instSB),
    ISADecoder.SH -> List(sInstType, wtRegFalse, instSH),
    ISADecoder.SW -> List(sInstType, wtRegFalse, instSW),
    ISADecoder.SD -> List(sInstType, wtRegFalse, instSD),
    // csr inst
    ISADecoder.CSRRW  -> List(iInstType, wtRegTrue, instCSRRW),
    ISADecoder.CSRRS  -> List(iInstType, wtRegTrue, instCSRRS),
    ISADecoder.CSRRC  -> List(iInstType, wtRegTrue, instCSRRC),
    ISADecoder.CSRRWI -> List(iInstType, wtRegTrue, instCSRRWI),
    ISADecoder.CSRRSI -> List(iInstType, wtRegTrue, instCSRRSI),
    ISADecoder.CSRRCI -> List(iInstType, wtRegTrue, instCSRRCI),
    // system inst
    ISADecoder.ECALL   -> List(nopInstType, wtRegFalse, instECALL),
    ISADecoder.MRET    -> List(nopInstType, wtRegFalse, instMRET),
    ISADecoder.FENCE   -> List(nopInstType, wtRegFalse, instFENCE),
    ISADecoder.FENCE_I -> List(nopInstType, wtRegFalse, instFENCE_I),
    // custom inst
    ISADecoder.CUST -> List(nopInstType, wtRegFalse, instCUST)
  )

  protected val immExten = Module(new ImmExten)
  protected val defRes   = List(nopInstType, wtRegFalse, instNOP)
  protected val decRes   = ListLookup(io.inst, defRes, decodeTable)
  immExten.io.inst     := io.inst
  immExten.io.instType := decRes(0)
  io.isa               := decRes(2)
  io.imm               := immExten.io.imm
  io.csr               := csr
  io.wen               := decRes(1) // NOTE: the csr inst type
}
